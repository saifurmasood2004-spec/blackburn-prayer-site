name: Update Hijri Date (ICOUK)

on:
  workflow_dispatch:
  schedule:
    - cron: "5 0 * * *"

permissions:
  contents: write

jobs:
  update-hijri:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: Fetch Hijri and write hijri.json
        env:
          ICOUK_BEARER_TOKEN: ${{ secrets.ICOUK_BEARER_TOKEN }}
        run: |
          set -e

          RESP="$(curl -sS \
            -H "Authorization: Bearer $ICOUK_BEARER_TOKEN" \
            "https://www.moonsighting.org.uk/api/index.php/v1/hijri?country=UK&return=json")"

          node -e '
            const obj = JSON.parse(process.env.RESP || "");
            const islamic = obj.islamic || [];
            const day = islamic[1] ?? "";
            const month = islamic[2] ?? "";
            const year = islamic[3] ?? "";
            if (!day || !month || !year) process.exit(2);
            const fs = require("fs");
            const out = {
              hijri: `${day} ${month} ${year}`,
              updated_at_utc: new Date().toISOString()
            };
            fs.writeFileSync("hijri.json", JSON.stringify(out, null, 2) + "\n", "utf8");
          '

      - name: Commit and push
        run: |
          if git diff --quiet; then
            echo "No changes."
            exit 0
          fi
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git add hijri.json
          git commit -m "Update hijri.json"
          git push
